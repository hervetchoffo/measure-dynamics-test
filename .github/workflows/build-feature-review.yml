name: Build review PDF and notify reviewers

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-review-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get current commit
        run: |
          echo "CURRENT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Injection des m√©tadonn√©es (version.tex)
        run: |
          echo "\\newcommand{\\BookVersion}{review-copy}" > version.tex
          echo "\\newcommand{\\BookBranch}{${{ github.head_ref }}}" >> version.tex
          echo "\\newcommand{\\BookCommit}{${{ env.CURRENT_COMMIT }}}" >> version.tex
          echo "\\newcommand{\\BookDate}{$(date +'%d/%m/%Y')}" >> version.tex
          echo "\\newcommand{\\BookStatus}{Version de relecture}" >> version.tex
          echo "\\newcommand{\\BookDisclaimer}{Cet ouvrage est en cours de r√©daction et peut contenir des erreurs.}" >> version.tex

      - name: Set up LaTeX and compile PDF
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          args: -pdf -interaction=nonstopmode -shell-escape
          compiler: latexmk

      - name: Check if PDF exists
        run: |
          if [ ! -f "main.pdf" ]; then
            echo "::error::PDF not found! Compilation failed."
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: review-pdf-${{ github.head_ref }}-${{ github.run_id }}
          path: main.pdf

      - name: Notify reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.runId;
            const pull_number = context.issue.number;
            const repo_url = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const artifact_url = `${repo_url}/actions/runs/${run_id}`;
            
            const body = `
            üìÑ **Nouveau PDF disponible pour relecture**
            - **Branche** : \`${{ github.head_ref }}\`
            - **Commit** : \`${{ env.CURRENT_COMMIT }}\`
            - **Statut** : Version de relecture

            üì• **[T√©l√©charger le PDF ici](${artifact_url})**
            *(Allez en bas de la page dans la section "Artifacts")*

            Merci de faire une relecture de ce document et de laisser vos commentaires ici!

            ---
            ### Checklist pour la relecture :
            - [ ] V√©rifier la coh√©rence des notations
            - [ ] Valider les d√©monstrations
            - [ ] Corriger les fautes de fran√ßais/typos
            - [ ] S'assurer que les r√©f√©rences sont correctes
            `;

            await github.rest.issues.createComment({
              issue_number: pull_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body.trim()
            });
